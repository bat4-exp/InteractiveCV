<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Chat analytics – local dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, sans-serif;
      background: #0b0f12;
      color: #e5e7eb;
      min-height: 100vh;
      padding: 1.5rem;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 1.5rem;
      color: #fde047;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .metric {
      background: rgb(15 20 25);
      border: 1px solid rgba(245, 197, 66, 0.25);
      border-radius: 0.75rem;
      padding: 1.25rem;
    }
    .metric-label {
      font-size: 0.8125rem;
      color: #9ca3af;
      margin-bottom: 0.25rem;
    }
    .metric-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #fff;
    }
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #d1d5db;
    }
    .country-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .country-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.75rem;
      background: rgb(15 20 25);
      border: 1px solid rgba(245, 197, 66, 0.2);
      border-radius: 0.5rem;
    }
    .country-name { font-weight: 500; color: #e5e7eb; }
    .country-count {
      font-size: 0.875rem;
      color: #fde047;
      font-weight: 600;
    }
    .empty {
      color: #6b7280;
      font-size: 0.875rem;
      padding: 1rem;
    }
    .refresh {
      margin-bottom: 1rem;
      font-size: 0.875rem;
      color: #9ca3af;
    }
    .refresh button {
      background: rgba(245, 197, 66, 0.2);
      color: #fde047;
      border: 1px solid rgba(245, 197, 66, 0.4);
      padding: 0.35rem 0.75rem;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .refresh button:hover {
      background: rgba(245, 197, 66, 0.3);
    }
  </style>
</head>
<body>
  <h1>Chat analytics</h1>
  <p class="refresh">
    <label for="source">Data source:</label>
    <select id="source">
      <option value="local">Local</option>
      <option value="production">Production</option>
    </select>
    <button type="button" id="refresh">Refresh</button>
  </p>
  <p class="refresh" style="margin-top: 0;">
    <span id="sourceHint">Local: data from chat usage on this machine.</span>
    Open <a href="/" style="color: #fde047;">CV site</a> and use the bot to add entries. For Production, set <code>VERCEL_API_URL</code> in <code>config.js</code> to your Vercel deployment URL (e.g. <code>https://your-app.vercel.app</code>).
  </p>
  <div class="metrics">
    <div class="metric">
      <div class="metric-label">Chats this week</div>
      <div class="metric-value" id="thisWeek">–</div>
    </div>
    <div class="metric">
      <div class="metric-label">Chats all time</div>
      <div class="metric-value" id="allTime">–</div>
    </div>
  </div>
  <div class="section-title">Requests by country</div>
  <ul class="country-list" id="countryList"></ul>

  <script src="config.js"></script>
  <script>
    function getApiUrl() {
      const source = document.getElementById('source').value;
      if (source === 'production' && window.API_CONFIG?.VERCEL_API_URL) {
        return window.API_CONFIG.VERCEL_API_URL.replace(/\/$/, '') + '/api/analytics';
      }
      return '/api/analytics';
    }

    function render(stats) {
      document.getElementById('thisWeek').textContent = stats.thisWeek;
      document.getElementById('allTime').textContent = stats.allTime;
      const list = document.getElementById('countryList');
      const entries = Object.entries(stats.byCountry || {}).sort((a, b) => b[1] - a[1]);
      if (entries.length === 0) {
        list.innerHTML = '<li class="empty">No data yet. Use the chat on the CV page to generate events.</li>';
        return;
      }
      list.innerHTML = entries
        .map(([country, count]) =>
          `<li><span class="country-name">${escapeHtml(country)}</span><span class="country-count">${count}</span></li>`
        )
        .join('');
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    async function load() {
      const api = getApiUrl();
      const isProduction = document.getElementById('source').value === 'production';
      try {
        const res = await fetch(api);
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        render(data);
      } catch (e) {
        document.getElementById('countryList').innerHTML =
          '<li class="empty">' + (isProduction
            ? 'Could not load production analytics. Is VERCEL_API_URL set in config.js and is the deployment using Vercel Blob?'
            : 'Could not load analytics. Is the local server running (pnpm start)?') + '</li>';
        document.getElementById('thisWeek').textContent = '–';
        document.getElementById('allTime').textContent = '–';
      }
    }

    function updateHint() {
      const sel = document.getElementById('source');
      const hint = document.getElementById('sourceHint');
      if (sel.value === 'production') {
        hint.textContent = window.API_CONFIG?.VERCEL_API_URL
          ? 'Production: real-time data from your live site (Vercel).'
          : 'Production: set VERCEL_API_URL in config.js to your Vercel URL to enable.';
      } else {
        hint.textContent = 'Local: data from chat usage on this machine.';
      }
    }

    document.getElementById('source').addEventListener('change', function() {
      updateHint();
      load();
    });
    document.getElementById('refresh').addEventListener('click', load);
    updateHint();
    load();
  </script>
</body>
</html>
